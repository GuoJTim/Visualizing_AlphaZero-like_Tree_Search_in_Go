<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Dashboard Layout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="index.js" defer></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="orangeBox.js" defer></script>
    <script src="blueBox.js" defer></script>
    <script src="purpleBox.js" defer></script>
    <script src="greenBox.js" defer></script>
    <script src="goBoard.js?wa" defer></script>
    <script src="readTree.js" defer></script>
    <script src="bluegoBoard.js" defer></script>
    <script src="DrawHeatmap.js" defer></script>
    <script src="bluestatus.js" defer></script>
    <script src="drawheatmapbar.js" defer></script>
    <script src="tree_diagram.js" defer></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .container {
            display: grid;
            grid-template-columns: 3fr 2fr 1fr;
            grid-template-rows: 4fr 1fr;
            gap: 10px;
            height: 100vh;
            padding: 20px;
        }

        .orange-box {
            grid-column: 1;
            grid-row: 1;
            border: 3px solid orange;
            height: 100%;
        }

        .blue-box {
            grid-column: 2;
            grid-row: 1;
            border: 3px solid blue;
            height: 100%;
        }

        .purple-box {
            grid-column: 3;
            grid-row: 1;
            border: 3px solid purple;
            height: 100%;
        }

        .green-box {
            grid-column: 1 / span 3;
            grid-row: 2;
            border: 3px solid green;
            height: 100%;
            overflow-x: scroll;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .slider-item {
            display: inline-block;
            width: 100px;
            height: 100%;
            margin: 0 20px;
            border: 2px solid black;
            vertical-align: middle;
        }

        .arrow {
            display: inline-block;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 10px;
        }

        .link {
            stroke: black;
            stroke-width: 0.05px;
            fill: none;
        }


        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }

            .orange-box, .blue-box, .purple-box, .green-box {
                grid-column: 1;
                grid-row: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="orange-box" id="orangeBox">
            <!-- Orange Box Content -->
            <div id="tree_diagram"></div>
        </div>
        <div class="blue-box" id="blueBox">
            <!-- Blue Box Content -->
        </div>
        <div class="purple-box" id="purpleBox">
            <!-- Purple Box Content -->
        </div>
        <div class="green-box" id="greenBox">
            <!-- Green Box Content -->
            <script>
                var tmp;
                </script>
            <div id="sliderContent"></div>
            <script type="module">
                document.addEventListener('DOMContentLoaded', async function () {
                    const boardSize = 9;
                    const sliderContent = d3.select('#sliderContent');
                
                    
                
                    // // Apply a single action to the board
                    // function applyAction(boardData, action) {
                    //     console.log(action)
                    //     if (action === "W[]" || action === "B[]") return;
                    //     if (action === "W[PASS]" || action === "B[PASS]") return;
                    //     const { color, row, col } = parseSGFAction(action);
                    //     console.log(row+" "+col)
                    //     boardData[row][col] = color;
                    // }
                
                    // Traverse the tree to generate board states
                    function generateBoardsFromTree(tree) {
                        
                        const initialBoard = Array(boardSize)
                            .fill(0)
                            .map(() => Array(boardSize).fill(0)); // Empty 9x9 board
                        // console.log(initialBoard)
                        const boards = [JSON.parse(JSON.stringify(initialBoard))]; // Start with initial board state
                        let currentNode = tree;
                        // console.log(currentNode)
                        while (currentNode && currentNode.children && currentNode.n > 0) {
                            // console.log(currentNode.n)
                            
                            const action = currentNode.action; // Get SGF action
                            if (action) {
                                const newBoard = JSON.parse(JSON.stringify(boards[boards.length - 1])); // Clone last board
                                applyAction(newBoard, action); // Apply action
                                boards.push(newBoard); // Add updated board to the list
                            }
                            // Find the next child node with the highest `n`
                            currentNode = currentNode.children.reduce((best, child) => {
                                if (child.n > 0 && (!best || child.n > best.n)) return child;
                                return best;
                            }, null);
                        }
                
                        return boards;
                    }
                
                    // Draw boards on green-box
                    // edited by cinsiang
                    function drawBoards(boards, nodes, heatmapBoards, colorBoards, root_info, top_info) {
                        sliderContent.selectAll('*').remove(); // Clear previous content
                
                        boards.forEach((boardData, step) => {
                            const sliderItem = sliderContent
                                .append('div')
                                .attr('class', 'slider-item')
                                .on('click', () => {
                                    console.log('Board clicked'); 
                                    const blueBox = d3.select('#blueBox');
                                    blueBox.selectAll('*').remove();
                                    drawBlueGoBoard(blueBox, boardData, heatmapBoards[step], colorBoards[step], 250);
                                    drawHeatmapBar(blueBox, colorScale, 300, 20);
                                    drawStatusBoard(blueBox, root_info, top_info);
                                });
                
                            drawGoBoard(sliderItem, boardData);
                
                            // Add arrows between steps
                            if (step < boards.length - 1) {
                                sliderContent
                                    .append('div')
                                    .attr('class', 'slider-arrow')
                                    .style('display', 'inline-block')
                                    .style('vertical-align', 'middle')
                                    .html('&#8594;'); // Right arrow symbol
                            }
                        });
                    }
                    
                    const csvFilePath = './game0_move10_game.csv';
                    fetch(csvFilePath)
                        .then(response => {
                            if (!response.ok) throw new Error(`Failed to load CSV file: ${response.statusText}`);
                            return response.text();
                        })
                        .then(content => {
                            // Parse the CSV
                            const header = [
                                'game', 'move', 'step', 'step_id', 'prev', 'color', 
                                'action', 'q', 'n', 'p', 'v', 'r', 'is_current'
                            ];
                            const rows = parseCSV(content);
                            const data = rows.map(row => header.map((_, index) => row[index] || ''));
                            // Build the tree
                            const tree = buildMCTSTree(data);
                            // Display the tree
                            // document.getElementById('output').textContent = JSON.stringify(tree, null, 2);
                            //edited by cinsiang
                            //==========================================
                            const allPValues = extractValuesFromTree(tree, "p");
                            const Pvalue = allPValues[198].flat();
                            const allVValues = extractValuesFromTree(tree, "v");
                            const Vvalue = allVValues[198].flat();
                            const allActionValues = extractValuesFromTree(tree, "action");
                            const actions = allActionValues[198].flat();
                            const root_info = info(tree, 198)
                            const heatmapBoards = generateHeatmapBoards(actions);
                            const policycolorBoards = generateColorBoards(actions, Pvalue);
                            const valuecolorBoards = generateColorBoards(actions, Vvalue);
                            const top_info = extractTopPValuesAndActions(Pvalue, actions);
                            //==========================================
                            tmp = tree
                            const boards = generateBoardsFromTree(tree[199][0]);
                            tmp = boards
                            // edited by cinsiang
                            // choose value or policy to draw heatmap: policycolorBoards or valuecolorBoards
                            drawBoards(boards, null, heatmapBoards, policycolorBoards, root_info, top_info);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            document.getElementById('output').textContent = `Error: ${error.message}`;
                    });

                });
                </script>
                
        </div>
    </div>
</body>
</html>
